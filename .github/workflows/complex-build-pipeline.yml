name: Complex Build Pipeline

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      skip_tests:
        description: 'Skip test phase'
        required: false
        default: false
        type: boolean
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  # =============================================================================
  # SETUP PHASE - Using reusable workflow
  # =============================================================================

  setup-phase:
    name: Setup Phase
    uses: ./.github/workflows/setup-reusable.yml

  # =============================================================================
  # BUILD PHASE - Using reusable workflow
  # =============================================================================

  build-phase:
    name: Build Phase
    uses: ./.github/workflows/build-reusable.yml
    needs: [setup-phase]
    with:
      build-version: ${{ needs.setup-phase.outputs.build-version }}

  # =============================================================================
  # TEST PHASE - Using reusable workflow
  # =============================================================================

  test-phase:
    name: Test Phase
    uses: ./.github/workflows/test-reusable.yml
    needs: [build-phase]
    with:
      skip-tests: ${{ inputs.skip_tests }}

  # =============================================================================
  # PACKAGE PHASE - Using reusable workflow
  # =============================================================================

  package-phase:
    name: Package Phase
    uses: ./.github/workflows/package-reusable.yml
    needs: [test-phase, setup-phase]
    if: ${{ !cancelled() && (success() || inputs.skip_tests) }}
    with:
      build-version: ${{ needs.setup-phase.outputs.build-version }}

  # =============================================================================
  # DEPLOY PHASE - Using reusable workflow
  # =============================================================================

  deploy-phase:
    name: Deploy Phase
    uses: ./.github/workflows/deploy-reusable.yml
    needs: [package-phase]
    with:
      package-version: ${{ needs.package-phase.outputs.package-version }}
      environment: ${{ inputs.environment }}

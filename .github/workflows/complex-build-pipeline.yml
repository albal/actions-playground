name: Complex Build Pipeline

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      skip_tests:
        description: 'Skip test phase'
        required: false
        default: false
        type: boolean
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  # =============================================================================
  # SETUP PHASE - Parallel execution
  # =============================================================================
  
  environment-setup:
    name: Environment Setup
    runs-on: ubuntu-latest
    outputs:
      build-version: ${{ steps.version.outputs.version }}
      cache-key: ${{ steps.cache-key.outputs.key }}
    steps:
      - name: Checkout code
        run: echo "ğŸ”„ Checking out code from repository"
        
      - name: Generate build version
        id: version
        run: |
          VERSION="1.0.${GITHUB_RUN_NUMBER}-${GITHUB_SHA::8}"
          echo "ğŸ·ï¸  Generated version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
      - name: Generate cache key
        id: cache-key
        run: |
          CACHE_KEY="deps-$(date +%Y%m%d)-${{ github.sha }}"
          echo "ğŸ”‘ Generated cache key: $CACHE_KEY"
          echo "key=$CACHE_KEY" >> $GITHUB_OUTPUT
          
      - name: Setup build environment
        run: |
          echo "ğŸ› ï¸  Setting up build environment"
          echo "ğŸ“¦ Installing base dependencies"
          echo "ğŸ”§ Configuring environment variables"
          sleep 2

  dependency-cache:
    name: Dependency Cache
    runs-on: ubuntu-latest
    steps:
      - name: Cache dependencies
        run: |
          echo "ğŸ“¦ Checking dependency cache"
          echo "ğŸ’¾ Cache miss - downloading dependencies"
          echo "ğŸ“¥ Downloading frontend dependencies"
          sleep 3
          echo "ğŸ“¥ Downloading backend dependencies"
          sleep 2
          echo "ğŸ“¥ Downloading test dependencies"
          sleep 1
          echo "âœ… Dependencies cached successfully"

  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    steps:
      - name: Run linting
        run: |
          echo "ğŸ” Running code linting"
          echo "ğŸ“ Checking JavaScript/TypeScript files"
          sleep 2
          echo "ğŸ“ Checking Python files"
          sleep 1
          echo "ğŸ“ Checking YAML files"
          sleep 1
          echo "âœ… Linting passed"
          
      - name: Security scan
        run: |
          echo "ğŸ”’ Running security vulnerability scan"
          echo "ğŸ” Scanning dependencies for known vulnerabilities"
          sleep 2
          echo "âœ… No security vulnerabilities found"

  # =============================================================================
  # BUILD PHASE - Parallel execution, depends on setup
  # =============================================================================
  
  frontend-build:
    name: Frontend Build
    runs-on: ubuntu-latest
    needs: [environment-setup, dependency-cache, code-quality]
    steps:
      - name: Build frontend
        run: |
          echo "ğŸ—ï¸  Building frontend application"
          echo "ğŸ“¦ Using version: ${{ needs.environment-setup.outputs.build-version }}"
          echo "ğŸ”§ Compiling TypeScript"
          sleep 3
          echo "ğŸ¨ Processing CSS/SASS files"
          sleep 2
          echo "ğŸ“¦ Bundling assets"
          sleep 2
          echo "ğŸ—œï¸  Minifying production build"
          sleep 2
          echo "âœ… Frontend build completed"
          
      - name: Upload frontend artifacts
        run: |
          echo "ğŸ“¤ Uploading frontend build artifacts"
          echo "ğŸ“¦ Artifact size: 15.2 MB"
          echo "âœ… Frontend artifacts uploaded"

  backend-build:
    name: Backend Build
    runs-on: ubuntu-latest
    needs: [environment-setup, dependency-cache, code-quality]
    steps:
      - name: Build backend
        run: |
          echo "ğŸ—ï¸  Building backend application"
          echo "ğŸ“¦ Using version: ${{ needs.environment-setup.outputs.build-version }}"
          echo "âš™ï¸  Compiling backend services"
          sleep 4
          echo "ğŸ”§ Building API gateway"
          sleep 2
          echo "ğŸ”§ Building microservices"
          sleep 3
          echo "ğŸ“¦ Creating service binaries"
          sleep 2
          echo "âœ… Backend build completed"
          
      - name: Upload backend artifacts
        run: |
          echo "ğŸ“¤ Uploading backend build artifacts"
          echo "ğŸ“¦ Artifact size: 42.1 MB"
          echo "âœ… Backend artifacts uploaded"

  database-build:
    name: Database Migration Scripts
    runs-on: ubuntu-latest
    needs: [environment-setup, dependency-cache, code-quality]
    steps:
      - name: Generate migration scripts
        run: |
          echo "ğŸ—„ï¸  Generating database migration scripts"
          echo "ğŸ“¦ Using version: ${{ needs.environment-setup.outputs.build-version }}"
          echo "ğŸ“ Analyzing schema changes"
          sleep 2
          echo "ğŸ“ Generating migration scripts"
          sleep 2
          echo "âœ… Database migrations ready"
          
      - name: Validate migrations
        run: |
          echo "ğŸ” Validating migration scripts"
          echo "âœ… All migrations validated"

  # =============================================================================
  # TEST PHASE - Parallel execution, depends on build
  # =============================================================================
  
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [frontend-build, backend-build, database-build]
    if: ${{ !inputs.skip_tests }}
    steps:
      - name: Run unit tests
        run: |
          echo "ğŸ§ª Running unit tests"
          echo "ğŸ”¬ Testing frontend components"
          sleep 2
          echo "ğŸ”¬ Testing backend services"
          sleep 3
          echo "ğŸ”¬ Testing database operations"
          sleep 2
          echo "ğŸ“Š Test Results:"
          echo "   Frontend: 127 tests passed"
          echo "   Backend: 89 tests passed"
          echo "   Database: 45 tests passed"
          echo "âœ… All unit tests passed"

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [frontend-build, backend-build, database-build]
    if: ${{ !inputs.skip_tests }}
    steps:
      - name: Run integration tests
        run: |
          echo "ğŸ”— Running integration tests"
          echo "ğŸ”§ Setting up test environment"
          sleep 2
          echo "ğŸ”Œ Testing API endpoints"
          sleep 4
          echo "ğŸ”Œ Testing service communication"
          sleep 3
          echo "ğŸ”Œ Testing database connectivity"
          sleep 2
          echo "ğŸ“Š Integration test results: 34 tests passed"
          echo "âœ… All integration tests passed"

  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: [frontend-build, backend-build, database-build]
    if: ${{ !inputs.skip_tests }}
    steps:
      - name: Run E2E tests
        run: |
          echo "ğŸ­ Running end-to-end tests"
          echo "ğŸŒ Starting test browser"
          sleep 2
          echo "ğŸ–±ï¸  Testing user workflows"
          sleep 5
          echo "ğŸ“± Testing mobile responsiveness"
          sleep 3
          echo "ğŸ” Testing accessibility"
          sleep 2
          echo "ğŸ“Š E2E test results: 18 scenarios passed"
          echo "âœ… All E2E tests passed"

  # =============================================================================
  # PACKAGE PHASE - Sequential execution, depends on tests
  # =============================================================================
  
  package-application:
    name: Package Application
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, e2e-tests]
    if: ${{ !cancelled() && (success() || inputs.skip_tests) }}
    outputs:
      package-version: ${{ steps.package.outputs.version }}
      package-size: ${{ steps.package.outputs.size }}
    steps:
      - name: Package application
        id: package
        run: |
          echo "ğŸ“¦ Packaging application"
          echo "ğŸ—ï¸  Creating deployment package"
          sleep 3
          echo "ğŸ—œï¸  Compressing assets"
          sleep 2
          echo "ğŸ“ Generating deployment manifest"
          sleep 1
          
          PACKAGE_VERSION="${{ needs.unit-tests.needs.frontend-build.needs.environment-setup.outputs.build-version || '1.0.0' }}"
          PACKAGE_SIZE="127.5 MB"
          
          echo "ğŸ“¦ Package created successfully"
          echo "   Version: $PACKAGE_VERSION"
          echo "   Size: $PACKAGE_SIZE"
          echo "version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
          echo "size=$PACKAGE_SIZE" >> $GITHUB_OUTPUT
          echo "âœ… Application packaged"

  generate-documentation:
    name: Generate Documentation
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, e2e-tests]
    if: ${{ !cancelled() && (success() || inputs.skip_tests) }}
    steps:
      - name: Generate API documentation
        run: |
          echo "ğŸ“š Generating API documentation"
          echo "ğŸ“ Extracting API definitions"
          sleep 2
          echo "ğŸ“ Generating OpenAPI specs"
          sleep 2
          echo "ğŸ“ Creating developer guides"
          sleep 2
          echo "âœ… Documentation generated"
          
      - name: Generate deployment docs
        run: |
          echo "ğŸ“‹ Generating deployment documentation"
          echo "ğŸ“ Creating deployment guides"
          sleep 1
          echo "ğŸ“ Generating configuration templates"
          sleep 1
          echo "âœ… Deployment documentation ready"

  # =============================================================================
  # DEPLOY PHASE - Sequential execution, depends on package
  # =============================================================================
  
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [package-application, generate-documentation]
    environment: staging
    outputs:
      deployment-url: ${{ steps.deploy.outputs.url }}
    steps:
      - name: Deploy to staging
        id: deploy
        run: |
          echo "ğŸš€ Deploying to staging environment"
          echo "ğŸ“¦ Using package: ${{ needs.package-application.outputs.package-version }}"
          echo "ğŸ”§ Configuring staging environment"
          sleep 2
          echo "ğŸ“¥ Downloading deployment package"
          sleep 2
          echo "ğŸš€ Deploying application"
          sleep 4
          echo "ğŸ”§ Running database migrations"
          sleep 2
          echo "ğŸ”„ Updating load balancer"
          sleep 1
          
          DEPLOYMENT_URL="https://staging.example.com"
          echo "url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "âœ… Deployment to staging completed"
          echo "ğŸŒ Application available at: $DEPLOYMENT_URL"

  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: [deploy-staging]
    steps:
      - name: Run smoke tests
        run: |
          echo "ğŸ’¨ Running smoke tests on staging"
          echo "ğŸŒ Testing deployment URL: ${{ needs.deploy-staging.outputs.deployment-url }}"
          echo "ğŸ” Testing health endpoints"
          sleep 2
          echo "ğŸ” Testing critical user paths"
          sleep 3
          echo "ğŸ” Testing database connectivity"
          sleep 1
          echo "ğŸ“Š Smoke test results: All critical paths working"
          echo "âœ… Smoke tests passed"

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [smoke-tests]
    if: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || (github.event_name == 'workflow_dispatch' && inputs.environment == 'production') }}
    environment: production
    steps:
      - name: Deploy to production
        run: |
          echo "ğŸš€ Deploying to production environment"
          echo "ğŸ“¦ Using package: ${{ needs.smoke-tests.needs.deploy-staging.needs.package-application.outputs.package-version }}"
          echo "âš ï¸  Production deployment requires manual approval"
          echo "ğŸ”§ Configuring production environment"
          sleep 3
          echo "ğŸ“¥ Downloading deployment package"
          sleep 2
          echo "ğŸš€ Deploying application"
          sleep 5
          echo "ğŸ”§ Running database migrations"
          sleep 3
          echo "ğŸ”„ Updating load balancer"
          sleep 2
          echo "ğŸ“Š Verifying deployment health"
          sleep 2
          echo "âœ… Production deployment completed"
          echo "ğŸŒ Application available at: https://production.example.com"

  # =============================================================================
  # NOTIFICATION PHASE - Runs after deployment
  # =============================================================================
  
  notify-success:
    name: Notify Success
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: ${{ success() }}
    steps:
      - name: Send success notification
        run: |
          echo "ğŸ“§ Sending success notification"
          echo "ğŸ‰ Deployment completed successfully"
          echo "ğŸ“¦ Version: ${{ needs.deploy-production.needs.smoke-tests.needs.deploy-staging.needs.package-application.outputs.package-version }}"
          echo "ğŸŒ Production URL: https://production.example.com"
          echo "ğŸ“Š Total pipeline duration: ~15 minutes"
          echo "âœ… Success notification sent"

  notify-failure:
    name: Notify Failure
    runs-on: ubuntu-latest
    needs: [environment-setup, dependency-cache, code-quality, frontend-build, backend-build, database-build, unit-tests, integration-tests, e2e-tests, package-application, generate-documentation, deploy-staging, smoke-tests, deploy-production]
    if: ${{ failure() }}
    steps:
      - name: Send failure notification
        run: |
          echo "ğŸ“§ Sending failure notification"
          echo "âŒ Pipeline failed"
          echo "ğŸ” Check the logs for more details"
          echo "ğŸš¨ Failure notification sent"
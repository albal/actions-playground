name: Setup Phase - Reusable Workflow

on:
  workflow_call:
    outputs:
      build-version:
        description: "Generated build version"
        value: ${{ jobs.environment-setup.outputs.build-version }}
      cache-key:
        description: "Generated cache key"
        value: ${{ jobs.environment-setup.outputs.cache-key }}

jobs:
  environment-setup:
    name: Environment Setup
    runs-on: ubuntu-latest
    outputs:
      build-version: ${{ steps.version.outputs.version }}
      cache-key: ${{ steps.cache-key.outputs.key }}
    steps:
      - name: Checkout code
        run: echo "ğŸ”„ Checking out code from repository"

      - name: Generate build version
        id: version
        run: |
          VERSION="1.0.${GITHUB_RUN_NUMBER}-${GITHUB_SHA::8}"
          echo "ğŸ·ï¸  Generated version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Generate cache key
        id: cache-key
        run: |
          CACHE_KEY="deps-$(date +%Y%m%d)-${{ github.sha }}"
          echo "ğŸ”‘ Generated cache key: $CACHE_KEY"
          echo "key=$CACHE_KEY" >> $GITHUB_OUTPUT

      - name: Setup build environment
        run: |
          echo "ğŸ› ï¸  Setting up build environment"
          echo "ğŸ“¦ Installing base dependencies"
          echo "ğŸ”§ Configuring environment variables"
          sleep 2

  dependency-cache:
    name: Dependency Cache
    runs-on: ubuntu-latest
    steps:
      - name: Cache dependencies
        run: |
          echo "ğŸ“¦ Checking dependency cache"
          echo "ğŸ’¾ Cache miss - downloading dependencies"
          echo "ğŸ“¥ Downloading frontend dependencies"
          sleep 3
          echo "ğŸ“¥ Downloading backend dependencies"
          sleep 2
          echo "ğŸ“¥ Downloading test dependencies"
          sleep 1
          echo "âœ… Dependencies cached successfully"

  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    steps:
      - name: Run linting
        run: |
          echo "ğŸ” Running code linting"
          echo "ğŸ“ Checking JavaScript/TypeScript files"
          sleep 2
          echo "ğŸ“ Checking Python files"
          sleep 1
          echo "ğŸ“ Checking YAML files"
          sleep 1
          echo "âœ… Linting passed"

      - name: Security scan
        run: |
          echo "ğŸ”’ Running security vulnerability scan"
          echo "ğŸ” Scanning dependencies for known vulnerabilities"
          sleep 2
          echo "âœ… No security vulnerabilities found"
